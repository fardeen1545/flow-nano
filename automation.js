import{dom as e}from"./dom.js";import{state as t}from"./state.js";import{logMessage as r,updateLiveStatus as o,updateProgressBar as n,updateButtonStates as a,updateFailedPromptsUI as s,updateQueueModal as i}from"./ui.js";import{i18n as l}from"./i18n.js";import{injectScript as d,clickNewProjectButton as c,scanExistingVideos as u,setInitialSettings as _,selectImageMode as m,selectTextMode as f,processImageAndPromptOnPage as g,processPromptOnPage as p,clickElementByXPath as I,scanForQueueFullPopup as w}from"./injector.js";import{getProjectIdFromUrl as b,readFileAsDataURL as R,getRandomWait as x,pauseIfNeeded as T,interruptibleSleep as h,interruptibleSleepAndScan as E,waitForTabLoad as y}from"./utils.js";import{startScanner as v,stopScanner as L}from"./scanner.js";import{getImage as P}from"./db.js";export function addFailedPrompt(e,r,o,n){const a=`job${n+1}_${"string"==typeof e?e:e.name||"unknown file"}`;if(!t.failedPromptsList.some(e=>e.key===a)){const i={key:a,item:e,reason:r,index:o};t.failedPromptsList.push(i),s();const l=t.masterQueue[n];if(l){const e=t.masterTaskList.find(e=>e.jobId===l.id&&e.index===o);e&&(e.status="failed")}}}export async function applyPageSettings(e){await h(2e3);try{await chrome.tabs.setZoom(t.flowTabId,.5)}catch(e){r(l("log_set_zoom_fail"),"warn")}await async function(){if(!t.selectors.GRID_VIEW_BUTTON_XPATH)return void r(l("log_grid_view_selector_not_found"),"warning");r(l("log_applying_grid_view"),"info");const e=await d(I,[t.selectors.GRID_VIEW_BUTTON_XPATH]);!0===e?(r(l("log_grid_view_clicked"),"info"),await h(500)):r(l(!1===e?"log_grid_view_not_clickable":"log_grid_view_xpath_error"),"warning")}(),await async function(){if(!t.selectors.VIDEOCAM_BUTTON_XPATH)return void r(l("log_videocam_selector_not_found"),"warning");r(l("log_applying_videocam_mode"),"info");const e=await d(I,[t.selectors.VIDEOCAM_BUTTON_XPATH]);!0===e?(r(l("log_videocam_clicked"),"info"),await h(500)):r(l(!1===e?"log_videocam_not_clickable":"log_videocam_xpath_error"),"warning")}();try{const e=await d(u);Array.isArray(e)&&e.length>0&&(e.forEach(e=>t.downloadedVideoUrls.add(e)),r(l("log_initial_scan_found",{count:e.length}),"info"))}catch(e){r(l("log_scan_existing_fail"),"warn")}const o=e.repeatCount||"1",n=e.model||"default",a=e.aspectRatio||"landscape";if(!await d(_,[o,n,a]))return r(l("log_settings_fail"),"error"),!1;let s=!1;return s="image-to-video"===e.mode?await d(m):await d(f),s?(r(l("log_settings_applied"),"info"),!0):(r(l("log_cannot_select_mode_after_reload",{mode:e.mode}),"error"),!1)}export async function startQueue(n=!1){t.zoomResetTimerId&&(clearTimeout(t.zoomResetTimerId),t.zoomResetTimerId=null),t.finalScanTimerId&&(clearInterval(t.finalScanTimerId),t.finalScanTimerId=null);const i=t.masterQueue.findIndex(e=>"pending"===e.status);if(-1!==i)try{if(0===Object.keys(t.selectors).length)throw new Error(l("log_load_selectors_fail"));const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!o||!o.id)throw new Error(l("log_no_active_tab"));t.flowTabId=o.id,t.isRunning=!0,t.stopRequested=!1,t.isPaused=!1,t.currentJobIndex=i,t.failedPromptsList=[],t.masterTaskList=[],a(),s(),e.logDisplay.innerHTML="",r(l("log_session_ready"),"system"),await j(n)}catch(e){r(l("status_start_error",{error:e.message}),"CRITICAL"),o(l("status_start_error",{error:e.message}),"error"),resetState(l("reset_error"))}else r(l("log_no_pending_jobs"),"warn")}async function j(s=!1){if(t.stopRequested)return void resetState(l("reset_user_stop"));if(t.finalScanTimerId&&(clearInterval(t.finalScanTimerId),t.finalScanTimerId=null),t.currentJobIndex=t.masterQueue.findIndex((e,r)=>"pending"===e.status&&r>=t.currentJobIndex),-1===t.currentJobIndex)return r(l("log_all_jobs_complete"),"system"),o(l("log_all_jobs_complete"),"success"),resetState(null),void a();const _=t.masterQueue[t.currentJobIndex];_.status="running",i();const m=parseInt(_.repeatCount,10)||1,f=_.startFrom||1;let I=Math.max(0,f-1);if(_.currentIndex>0&&_.currentIndex>I?I=_.currentIndex:_.currentIndex=I,t.taskList=[],"image-to-video"===_.mode)for(let e=0;e<_.images.length;e++){const r={index:e+1,item:_.images[e],prompt:_.prompts[e%_.prompts.length],status:"pending",expectedVideos:m,foundVideos:0,jobId:_.id};t.taskList.push(r),t.masterTaskList.push(r)}else for(let e=0;e<_.prompts.length;e++){const r={index:e+1,item:_.prompts[e],prompt:_.prompts[e],status:"pending",expectedVideos:m,foundVideos:0,jobId:_.id};t.taskList.push(r),t.masterTaskList.push(r)}t.promptList=t.taskList.map(e=>e.item),t.currentMode=_.mode,t.currentIndex=_.currentIndex,await async function(a,s){let _=s&&(await chrome.tabs.get(t.flowTabId)).url?.includes("/tools/flow/project");try{if(_){t.currentProjectId=b((await chrome.tabs.get(t.flowTabId)).url),r(l("log_continuing_job",{index:t.currentJobIndex+1}),"system"),r(l("log_continue_on_project",{id:t.currentProjectId||"N/A"}),"info");try{const e=await d(u);Array.isArray(e)&&e.length>0&&(e.forEach(e=>t.downloadedVideoUrls.add(e)),r(l("log_initial_scan_found",{count:e.length}),"info"))}catch(e){r(l("log_scan_existing_fail"),"warn")}}else{if(t.downloadedVideoUrls.clear(),o(l("status_creating_project"),"info"),r(l("log_starting_job",{index:t.currentJobIndex+1}),"system"),await chrome.tabs.update(t.flowTabId,{url:"https://labs.google/fx/tools/flow"}),await new Promise((e,r)=>{const o=(n,a,s)=>{n===t.flowTabId&&s.url?.includes("/tools/flow")&&!s.url?.includes("/project")&&"complete"===a.status?(chrome.tabs.onUpdated.removeListener(o),e()):n!==t.flowTabId||"complete"!==a.status||s.url?.includes("/tools/flow")||s.url?.includes("accounts.google.com")||(chrome.tabs.onUpdated.removeListener(o),r(new Error(l("log_nav_error_or_unexpected_page",{url:s.url}))))};chrome.tabs.onUpdated.addListener(o),setTimeout(()=>{chrome.tabs.onUpdated.removeListener(o),r(new Error(l("log_timeout_nav_homepage")))},6e4)}),await h(2e3),t.stopRequested)return void resetState(l("reset_user_stop"));r(l("log_homepage_loaded"),"info");if(!await d(c))throw new Error(l("log_click_new_project_fail"));r(l("log_wait_for_project"),"info"),await new Promise((e,r)=>{const o=(n,a,s)=>{n===t.flowTabId&&s.url?.includes("/project/")&&"complete"===a.status?(chrome.tabs.onUpdated.removeListener(o),e()):n!==t.flowTabId||"complete"!==a.status||s.url?.includes("/project/")||(s.url?.includes("/tools/flow")?(chrome.tabs.onUpdated.removeListener(o),r(new Error(l("log_fail_nav_from_homepage")))):s.url?.includes("accounts.google.com")||(chrome.tabs.onUpdated.removeListener(o),r(new Error(l("log_unexpected_page_after_click",{url:s.url})))))};chrome.tabs.onUpdated.addListener(o),setTimeout(()=>{chrome.tabs.onUpdated.removeListener(o),r(new Error(l("error_timeout_new_project")))},6e4)});const e=(await chrome.tabs.get(t.flowTabId)).url;t.currentProjectId=b(e),r(l("log_navigated_to_project",{id:t.currentProjectId||"N/A"}),"info")}if(!await applyPageSettings(a))throw new Error(l("log_apply_initial_settings_fail"));if(t.stopRequested)return void resetState(l("reset_user_stop"));if(t.currentIndex>=t.taskList.length){const e=l("status_invalid_start_pos",{start:t.currentIndex+1,total:t.taskList.length});return o(e,"error"),r(e,"error"),a.status="done",i(),chrome.storage.local.set({masterQueue:t.masterQueue}),t.currentJobIndex++,void await j(!1)}L(),e.autoDownloadCheckbox.checked?(v("main"),r(l("log_scanner_started",{interval:t.scanIntervalMs/1e3}),"info")):r(l("log_auto_scan_off"),"info"),t.newlyDownloadedCount=0,t.activeRunMode=t.currentMode,chrome.storage.local.set({lastRunMode:t.currentMode}),await async function(a){const s=t.taskList.length,c=a.aspectRatio||"landscape";for(;t.currentIndex<s&&t.isRunning&&!t.stopRequested&&(await T(),!t.stopRequested);){const u=t.taskList[t.currentIndex];let _=!1,m=!1;a.progress.completed=t.currentIndex,i();for(let i=0;i<=t.MAX_RETRIES&&(await T(),!t.stopRequested);i++){if(i>0){r(l("log_retry_task",{index:u.index,retry:i}),"warn"),e.autoDownloadCheckbox.checked&&await h(t.scanIntervalMs);try{if(await new Promise((e,r)=>{chrome.tabs.reload(t.flowTabId,{bypassCache:!0},()=>{if(chrome.runtime.lastError)return r(new Error(chrome.runtime.lastError.message));e()})}),await y(t.flowTabId),!await applyPageSettings(a))throw new Error(l("log_settings_fail"))}catch(e){if(e.message===l("reset_user_stop")){r(l("reset_user_stop"),"warn"),_=!0;break}const o=l("log_page_reload_fail")+`: ${e.message}`;r(o,"CRITICAL"),addFailedPrompt(u.item,o,u.index,t.currentJobIndex),_=!0;break}if(!await S()){_=!0;break}}let f,I;if(n(t.currentIndex,s,t.currentJobIndex,t.masterQueue.length),"image-to-video"===a.mode){const e=u.item;let n;f=l("log_processing_image",{index:u.index,total:s,retry:i,maxRetry:t.MAX_RETRIES}),r(f,"info"),o(f,"info");try{const t=await P(e.id);t?n=await R(t):I="FILE_READ_ERROR"}catch(e){I="FILE_READ_ERROR"}"FILE_READ_ERROR"!==I&&(I=n?await d(g,[n,e.name,e.type,u.prompt,c]):"FILE_READ_ERROR")}else f=l("log_processing",{index:u.index,total:s,retry:i,maxRetry:t.MAX_RETRIES}),r(f,"info"),o(f,"info"),I=await d(p,[u.prompt,t.selectors.PROMPT_TEXTAREA_ID,t.selectors.GENERATE_BUTTON_XPATH]);if(!0===I){r(l("log_submit_success",{index:u.index}),"success"),_=!1;break}if("QUEUE_FULL"===I){r(l("log_queue_full"),"warn");if(await A()){i--;continue}_=!0,i===t.MAX_RETRIES&&(r(l("log_queue_full_gave_up"),"error"),addFailedPrompt(u.item,l("log_queue_full"),u.index,t.currentJobIndex));continue}{_=!0;let e=l("reason_unknown");const o="image-to-video"===a.mode?u.item.name:"N/A";if("POLICY_IMAGE"===I?e=l("log_policy_error_image",{filename:o}):"POLICY_PROMPT"===I?e=l("log_policy_error_prompt"):"FILE_READ_ERROR"===I?e=l("log_file_read_error",{filename:o}):!1===I&&(e="image-to-video"===a.mode?l("log_image_inject_fail"):l("log_submit_fail")),r(e,"error"),"POLICY_IMAGE"===I||"POLICY_PROMPT"===I){m=!0,addFailedPrompt(u.item,e,u.index,t.currentJobIndex);break}i===t.MAX_RETRIES&&(r(l("log_skip_task",{index:u.index,maxRetry:t.MAX_RETRIES}),"error"),addFailedPrompt(u.item,e,u.index,t.currentJobIndex))}}if(t.stopRequested)break;if(!_||m){const t=x(e.minInitialWaitTimeInput.value,e.maxInitialWaitTimeInput.value);if(r(l("log_wait_for_video",{seconds:Math.round(t/1e3)}),"info"),m)await h(t);else{const e=await E(t);if("STOPPED"===e)break;"POLICY_ERROR"===e&&(r(l("log_policy_error_prompt"),"error"),_=!0)}}if(t.stopRequested)break;_||r(l("log_prompt_completed",{index:u.index}),"system"),t.currentIndex++,a.currentIndex=t.currentIndex}if(t.stopRequested)a.status="pending",i(),resetState(l("reset_user_stop"));else if(t.isRunning)if(a.status="done",a.progress.completed=s,i(),chrome.storage.local.set({masterQueue:t.masterQueue}),e.autoDownloadCheckbox.checked){r(l("log_job_scan_started",{index:t.currentJobIndex+1}),"system"),o(l("log_job_scan_started",{index:t.currentJobIndex+1}),"info");const e=Date.now(),n=18e4,a=5e3;t.finalScanTimerId=setInterval(async()=>{if(t.currentJobIndex>=t.masterQueue.length||!t.masterQueue[t.currentJobIndex])return clearInterval(t.finalScanTimerId),void(t.finalScanTimerId=null);const o=t.masterQueue[t.currentJobIndex].id,a=t.masterTaskList.filter(e=>e.jobId===o),s=a.length>0&&a.every(e=>"complete"===e.status||"failed"===e.status),i=Date.now()-e;let d=!1,c="";s?(c="log_job_scan_complete_early",d=!0):i>=n&&(c="log_job_scan_timeout",d=!0),d&&(r(l(c,{index:t.currentJobIndex+1}),"success"),clearInterval(t.finalScanTimerId),t.finalScanTimerId=null,t.currentJobIndex++,await j(!1))},a)}else t.currentJobIndex++,await j(!1)}(a)}catch(e){r(l("log_critical_job_error",{index:t.currentJobIndex+1,error:e.message}),"CRITICAL"),o(l("status_start_error",{error:e.message}),"error"),a.status="failed",i(),t.currentJobIndex++,await j(!1)}}(_,s)}async function k(e,n,a){for(let s=1;s<=e;s++){if(await T(),t.stopRequested)return"STOPPED";const e=await d(w);if(void 0===e)return"ERROR";if(!e)return r(l("log_queue_cleared_after_wait"),"info"),"CLEARED";const i=l("log_queue_full_retrying",{attempt:s+a,total:30});r(i,"warn"),o(i,"warn"),await h(n)}return"STILL_FULL"}async function A(){let e;return e=await k(10,1e4,0),"CLEARED"===e||"STOPPED"!==e&&"ERROR"!==e&&(r(l("log_queue_full_wait_30s"),"warn"),await h(3e4),!t.stopRequested&&(e=await k(10,1e4,10),"CLEARED"===e))}async function S(){let e=await k(10,1e4,20);if("CLEARED"===e)return!0;if("STOPPED"===e||"ERROR"===e)return!1;const t=l("log_queue_full_gave_up");return r(t,"CRITICAL"),resetState(t),!1}export function resetState(n){if(L(),t.finalScanTimerId&&(clearInterval(t.finalScanTimerId),t.finalScanTimerId=null),t.flowTabId){const e=t.flowTabId;t.zoomResetTimerId&&clearTimeout(t.zoomResetTimerId),t.zoomResetTimerId=setTimeout(()=>{try{chrome.tabs.get(e,t=>{t&&t.id===e&&chrome.tabs.setZoom(e,1).catch(e=>{})})}catch(e){}t.zoomResetTimerId=null},500)}if(t.isRunning=!1,t.stopRequested=!1,t.isPaused=!1,t.currentIndex=0,t.currentJobIndex=0,t.flowTabId=null,t.currentProjectId=null,t.newlyDownloadedCount=0,t.imageFileList=[],t.promptList=[],t.taskList=[],t.masterTaskList=[],t.masterQueue.forEach(e=>{"running"===e.status&&(e.status="pending")}),e.imageFileSummary&&(e.imageFileSummary.style.display="none"),e.imageCount&&(e.imageCount.textContent="0"),e.imageInput&&(e.imageInput.value=null),t.activeRunMode=null,chrome.storage.local.set({lastRunMode:null,masterQueue:t.masterQueue}),i(),a(),t.isRunning||t.downloadInterval||t.finalScanTimerId||(e.mainActionButton&&(e.mainActionButton.style.display="flex"),e.startNewProjectButton&&(e.startNewProjectButton.style.display="none"),e.startCurrentProjectButton&&(e.startCurrentProjectButton.style.display="none"),e.progressBar&&(e.progressBar.value=0)),n){let e="warn";n.includes("✅")||n===l("log_all_jobs_complete")?e="success":(n.includes("Lỗi")||n.includes("Error")||n.includes("Stopped")||n.includes("Dừng")||n.includes(l("log_queue_full_gave_up"))||n.includes(l("error_tab_closed")))&&(e="error");let t=e;"success"!==e&&"info"!==e||(t="system"),r(n,t),o(n,e)}else o(l("status_ready"))}