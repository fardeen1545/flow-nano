import{dom as e}from"./dom.js";import{state as t}from"./state.js";import{updateMainButton as o,updateLiveStatus as r,updateButtonStates as a,updateInterfaceVisibility as n,updateUIAfterModeChange as s,logMessage as i,updateQueueModal as l}from"./ui.js";import{i18n as u}from"./i18n.js";import{setLanguage as c}from"./language.js";import{startQueue as d,resetState as m}from"./automation.js";import{startScanner as g,stopScanner as p}from"./scanner.js";import{sortImageFiles as f,readFileAsDataURL as v}from"./utils.js";import{saveImage as _,clearAllImages as h,deleteImage as y}from"./db.js";function x(){if(!e.mainActionButton||!e.startNewProjectButton||!e.startCurrentProjectButton)return;const a=t.masterQueue.some(e=>"pending"===e.status);if(0!==t.masterQueue.length&&a||t.isRunning)if(t.isRunning)if(t.isPaused=!t.isPaused,o(),t.isPaused){const e=(t.masterQueue[t.currentJobIndex]||{taskList:[]}).currentIndex||0;r(u("status_paused",{index:e+1}),"warn"),i(u("log_paused"),"warn")}else i(u("log_resumed"),"info"),r(u("log_resumed"),"info");else e.mainActionButton.style.display="none",e.startNewProjectButton.style.display="flex",e.startCurrentProjectButton.style.display="flex"}function L(t){e.mainActionButton&&e.startNewProjectButton&&e.startCurrentProjectButton&&(e.mainActionButton.style.display="flex",e.startNewProjectButton.style.display="none",e.startCurrentProjectButton.style.display="none",d(t))}function b(){if(t.isRunning||t.downloadInterval){t.stopRequested=!0,t.isPaused=!1,i(u("log_stop_request"),"warn");const e=!!t.finalScanTimerId;t.finalScanTimerId&&(clearInterval(t.finalScanTimerId),t.finalScanTimerId=null),e&&t.isRunning&&m(u("reset_user_stop"),!1),t.isRunning||m(u("reset_user_stop"),!1)}}function I(e){t.currentMode=e.target.value,chrome.storage.local.set({mode:t.currentMode}),s()}function j(o){t.imageFileList=Array.from(o.target.files);const r=e.imageSortSelector.value;f(r),e.imageCount.textContent=t.imageFileList.length,e.imageFileSummary.style.display="block";const a=e.imageSortSelector.options[e.imageSortSelector.selectedIndex].text;i(u("log_images_sorted",{count:t.imageFileList.length,order:a}),"info")}function w(o){const r=o.target.value;chrome.storage.local.set({imageSort:r}),f(r);const a=e.imageSortSelector.options[e.imageSortSelector.selectedIndex].text;i(u("log_images_sorted",{count:t.imageFileList.length,order:a}),"info")}function E(t){const o=t.target.files[0];if(o){const t=new FileReader;t.onload=t=>{if(e.promptsTextarea){const o=e.promptsTextarea.value.trim(),r=t.target.result.trim();e.promptsTextarea.value=o?`${o}\n\n${r}`:r,chrome.storage.local.set({prompts:e.promptsTextarea.value})}},t.onerror=e=>i(u("log_txt_read_error",{error:e.target.error}),"error"),t.readAsText(o)}t.target.value=null}async function Q(){try{const e=await chrome.tabs.query({url:"*://*/*tools/flow*"});let t=e.find(e=>e.url?.includes("/project"))||e.find(e=>e.url?.includes("/tools/flow"));t?(await chrome.tabs.update(t.id,{active:!0}),await chrome.windows.update(t.windowId,{focused:!0})):await chrome.tabs.create({url:"https://labs.google/fx/tools/flow"})}catch(e){i(u("log_nav_to_flow_error"),"error")}}function S(){const e=t.failedPromptsList.sort((e,t)=>null!=e.index&&null!=t.index?e.index-t.index:null!=e.index?-1:null!=t.index?1:0).map(e=>null!=e.index?`${e.index}. ${e.key}`:e.key).join("\n\n");if(e)try{navigator.clipboard.writeText(e).then(()=>r(u("status_copy_success"),"success"),()=>r(u("status_copy_fail"),"error"))}catch(e){r(u("status_copy_fail"),"error")}}export function handleTabRemoval(e){e===t.flowTabId&&(t.isRunning||t.downloadInterval)&&m(u("error_tab_closed"),!1)}function k(){chrome.storage.local.set({autoDownload:e.autoDownloadCheckbox.checked}),e.autoDownloadCheckbox.checked||!t.downloadInterval||t.isRunning||p(),a()}async function C(){const o=e.modeSelector.value,a=e.promptsTextarea.value.trim().split(/[\r\n]{2,}/).filter(e=>e.trim()),n=[...t.imageFileList];let s=e.jobDownloadFolderInput.value.trim();s||(s=u("job_folder_default"));const c=s;e.jobDownloadFolderInput.value=c;const d=e.repeatCountInput.value,m=e.modelSelector.value,g=e.aspectRatioSelector.value,p=parseInt(e.startFromInput.value,10)||1;let f=[];if("text-to-video"===o&&0===a.length)return i(u("log_queue_job_add_fail_prompt"),"error"),void r(u("log_queue_job_add_fail_prompt"),"error");if("image-to-video"===o){if(0===n.length)return i(u("log_queue_job_add_fail_image"),"error"),void r(u("log_queue_job_add_fail_image"),"error");if(0===a.length)return i(u("log_queue_job_add_fail_prompt"),"error"),void r(u("log_queue_job_add_fail_prompt"),"error");try{for(const e of n){const t=await _(e);f.push(t)}}catch(e){return i(u("log_db_save_error",{error:e.message}),"error"),void r(u("status_db_save_error",{error:e.message}),"error")}if(0===f.length&&n.length>0)return i(u("log_db_read_all_fail"),"error"),void r(u("status_db_read_all_fail"),"error")}const v={id:Date.now().toString(),mode:o,prompts:a,images:f,downloadFolder:c,repeatCount:d,model:m,aspectRatio:g,startFrom:p,status:"pending",progress:{completed:0,total:"image-to-video"===o?f.length:a.length},currentIndex:0};t.masterQueue.push(v),chrome.storage.local.set({masterQueue:t.masterQueue}),i(u("log_queue_job_added",{count:t.masterQueue.length}),"success"),l(),e.promptsTextarea.value="",t.imageFileList=[],e.imageInput.value=null,e.imageCount.textContent="0",e.imageFileSummary.style.display="none",chrome.storage.local.set({prompts:""}),t.nextProjectCounter++,chrome.storage.local.set({nextProjectCounter:t.nextProjectCounter});const h=`${u("job_folder_prefix")||"Project-"}${t.nextProjectCounter.toString().padStart(2,"0")}`;e.jobDownloadFolderInput.value=h}function B(){l(),e.queueModalOverlay.style.display="flex"}function q(){e.queueModalOverlay.style.display="none"}function T(e){if(e.target.classList.contains("queue-folder-input")){const o=e.target.dataset.jobId,r=e.target.value.trim(),a=t.masterQueue.find(e=>e.id===o);a&&"pending"===a.status&&(a.downloadFolder=r,e.target.value=r,chrome.storage.local.set({masterQueue:t.masterQueue}))}}async function F(e){const o=e.target.closest(".queue-reset-job");if(o){const e=o.closest("tr").dataset.jobId,r=t.masterQueue.find(t=>t.id===e);return void(r&&"pending"!==r.status&&"running"!==r.status&&(r.status="pending",r.progress.completed=0,r.currentIndex=0,chrome.storage.local.set({masterQueue:t.masterQueue}),l()))}const r=e.target.closest(".queue-delete-job");if(r){const e=r.closest("tr").dataset.jobId,o=t.masterQueue.findIndex(t=>t.id===e);if(o>-1){const e=t.masterQueue[o];if("running"===e.status)return void i(u("log_queue_delete_fail_running"),"error");if("image-to-video"===e.mode&&e.images)try{for(const t of e.images)await y(t.id)}catch(e){i(u("log_db_delete_error",{error:e.message}),"error")}t.masterQueue.splice(o,1),chrome.storage.local.set({masterQueue:t.masterQueue}),l(),i(u("log_queue_job_deleted",{index:o+1}),"warn")}}}function P(){t.isRunning||e.confirmClearQueueModal&&(e.confirmClearQueueModal.style.display="flex")}function R(){if(t.isRunning)return;let e=!1;t.masterQueue.forEach(t=>{"done"!==t.status&&"failed"!==t.status||(t.status="pending",t.progress.completed=0,t.currentIndex=0,e=!0)}),e&&(chrome.storage.local.set({masterQueue:t.masterQueue}),l())}function A(){t.isRunning||(e.confirmClearQueueModal&&(e.confirmClearQueueModal.style.display="none"),t.masterQueue=[],chrome.storage.local.set({masterQueue:[]},()=>{h().then(()=>{i(u("log_queue_cleared"),"warn"),l()})}))}function D(){e.confirmClearQueueModal&&(e.confirmClearQueueModal.style.display="none")}export function attachEventListeners(){try{document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-tab");document.querySelectorAll(".tab-button.active").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-pane.active").forEach(e=>e.classList.remove("active")),e.classList.add("active"),document.getElementById(`content-${t}`)?.classList.add("active")})}),e.mainActionButton.addEventListener("click",x),e.startNewProjectButton.addEventListener("click",()=>L(!1)),e.startCurrentProjectButton.addEventListener("click",()=>L(!0)),e.stopButton.addEventListener("click",b),e.promptsTextarea.addEventListener("input",()=>chrome.storage.local.set({prompts:e.promptsTextarea.value})),e.startFromInput.addEventListener("input",()=>chrome.storage.local.set({startFrom:e.startFromInput.value})),e.repeatCountInput.addEventListener("change",e=>chrome.storage.local.set({videoCount:e.target.value})),e.minInitialWaitTimeInput.addEventListener("input",()=>chrome.storage.local.set({minInitialWait:e.minInitialWaitTimeInput.value})),e.maxInitialWaitTimeInput.addEventListener("input",()=>chrome.storage.local.set({maxInitialWait:e.maxInitialWaitTimeInput.value})),e.languageSelector.addEventListener("change",e=>c(e.target.value)),e.autoDownloadCheckbox.addEventListener("change",k),e.modeSelector.addEventListener("change",I),e.aspectRatioSelector.addEventListener("change",e=>chrome.storage.local.set({aspectRatio:e.target.value})),e.modelSelector.addEventListener("change",e=>chrome.storage.local.set({model:e.target.value})),e.uploadImageButton.addEventListener("click",()=>e.imageInput.click()),e.imageInput.addEventListener("change",j),e.imageSortSelector.addEventListener("change",w),e.uploadPromptButton.addEventListener("click",()=>e.fileInput.click()),e.fileInput.addEventListener("change",E),e.navigateToFlowButton.addEventListener("click",Q),e.copyFailedButton.addEventListener("click",S),e.openDownloadsSettingsLink.addEventListener("click",e=>{e.preventDefault();try{chrome.runtime.sendMessage({type:"openDownloadsSettings"})}catch(e){i(u("log_open_settings_fail"),"error")}}),e.addToQueueButton.addEventListener("click",C),e.openQueueButton.addEventListener("click",B),e.clearQueueButton.addEventListener("click",P),e.closeQueueModal.addEventListener("click",q),e.queueListDisplay.addEventListener("click",F),e.queueListDisplay.addEventListener("change",T),e.confirmClearQueueButton.addEventListener("click",A),e.cancelClearQueueButton.addEventListener("click",D),e.queueResetAllButton.addEventListener("click",R),e.queueDeleteAllButton.addEventListener("click",P)}catch(e){i(u("log_event_listener_error",{error:e.message}),"error")}}export function attachChromeListeners(){chrome.tabs.onActivated.addListener(n),chrome.tabs.onUpdated.addListener((e,t,o)=>{chrome.tabs.query({active:!0,currentWindow:!0},o=>{o?.length>0&&e===o[0].id&&(t.status||t.url)&&n()})}),chrome.tabs.onRemoved.addListener(handleTabRemoval)}