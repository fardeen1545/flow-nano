import{state as e}from"./state.js";import{logMessage as t}from"./ui.js";import{i18n as n}from"./i18n.js";export async function injectScript(l,o=[]){let u=e.flowTabId;if(!u)try{const[l]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!l?.url?.includes("/tools/flow"))return void t(n("log_critical_error"),"error");u=l.id,e.flowTabId=l.id}catch(e){return void t(n("log_critical_error"),"error")}try{await chrome.tabs.get(u)}catch(t){throw e.isRunning||e.downloadInterval,t}try{const r=await chrome.scripting.executeScript({target:{tabId:u},func:l,args:[...o,e.selectors],world:"MAIN"});if(chrome.runtime.lastError){const l=chrome.runtime.lastError.message||n("log_unknown_runtime_error");return void(e.stopRequested||l.includes(n("log_connection_error"))||l.includes(n("log_no_tab_error"))||l.includes(n("log_receiving_end_error"))||l.includes(n("log_target_page_error"))?(e.isRunning||e.downloadInterval)&&!l.includes(n("log_no_tab_error"))&&l.includes(n("log_target_page_error")):t(n("log_scripting_error",{error:n("log_runtime_error",{error:l})}),"error"))}return r?.[0]?.error?void t(n("log_scripting_error",{error:n("log_injected_script_error",{error:r[0].error.message||r[0].error})}),"error"):void 0!==r?.[0]?.result?r[0].result:void 0}catch(l){const o=l.message||String(l);return void(e.stopRequested||o.includes(n("log_connection_error"))||o.includes(n("log_no_tab_error"))?e.isRunning||e.downloadInterval:t(n("log_scan_inject_failed",{error:o}),"error"))}}export function clickElementByXPath(e){try{const t=document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(t)try{return t.click(),!0}catch(e){try{return t.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window})),!0}catch(e){return!1}}return}catch(e){return}}export function clickNewProjectButton(e){const t=e?.NEW_PROJECT_BUTTON_XPATH;if(!t)return!1;let n=null;try{n=document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(e){return!1}if(n)try{return n.click(),!0}catch(e){return!1}return!1}export async function scanForQueueFullPopup(e){return!!document.evaluate(e.QUEUE_FULL_POPUP_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}export async function processPromptOnPage(e,t,n,l){if(!t||!n)return!1;const o=document.getElementById(t);if(!o)return!1;const u=n;try{o.focus(),await new Promise(e=>setTimeout(e,50)),Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value").set.call(o,e),o.dispatchEvent(new Event("input",{bubbles:!0})),await new Promise(e=>setTimeout(e,50)),o.blur(),await new Promise(e=>setTimeout(e,50))}catch(e){return!1}for(let e=0;e<30;e++){let e=null;try{e=document.evaluate(u,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(e){}if(e&&!e.disabled)try{e.click(),await new Promise(e=>setTimeout(e,1e3));for(let e=0;e<10;e++){if(document.evaluate(l.QUEUE_FULL_POPUP_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue)return"QUEUE_FULL";if(document.evaluate(l.PROMPT_POLICY_ERROR_POPUP_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue)return"POLICY_PROMPT";await new Promise(e=>setTimeout(e,1e3))}return!0}catch(e){return!1}await new Promise(e=>setTimeout(e,200))}return!1}export async function selectImageMode(e){try{const t=document.evaluate(e.MODE_DROPDOWN_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(!t)return!1;if(t.textContent&&(t.textContent.includes("Tạo video từ các khung hình")||t.textContent.includes("Image-to-Video")))return!0;t.click(),await new Promise(e=>setTimeout(e,500));const n=document.evaluate(e.IMAGE_TO_VIDEO_MODE_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return!!n&&(n.click(),await new Promise(e=>setTimeout(e,500)),!0)}catch(e){return!1}}export async function selectTextMode(e){try{const t=document.evaluate(e.MODE_DROPDOWN_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(!t)return!1;if(t.textContent&&(t.textContent.includes("Từ văn")||t.textContent.includes("Text-to-Video")))return!0;t.click(),await new Promise(e=>setTimeout(e,500));const n=document.evaluate(e.TEXT_TO_VIDEO_MODE_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return!!n&&(n.click(),await new Promise(e=>setTimeout(e,500)),!0)}catch(e){return!1}}export async function setInitialSettings(e,t,n,l){try{const o=document.evaluate(l.SETTINGS_BUTTON_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(!o)return!1;o.click(),await new Promise(e=>setTimeout(e,1e3));const u={1:l.OUTPUT_NUMBER_ONE_XPATH,2:l.OUTPUT_NUMBER_TWO_XPATH,3:l.OUTPUT_NUMBER_THREE_XPATH,4:l.OUTPUT_NUMBER_FOUR_XPATH},r=document.evaluate(l.OUTPUT_NUMBER_BUTTON_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(!r)return!1;r.click(),await new Promise(e=>setTimeout(e,500));const a=document.evaluate(u[e],document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(!a)return!1;a.click(),await new Promise(e=>setTimeout(e,500));const i={veo2_fast:l.MODEL_VEO_2_FAST_XPATH,veo3_quality:l.MODEL_VEO_3_QUALITY_XPATH,veo2_quality:l.MODEL_VEO_2_QUALITY_XPATH,default:l.MODEL_VEO_3_FAST_XPATH,veo3_fast_low:l.MODEL_VEO_3_FAST_LOW_XPATH},c="default"!==t&&i[t]?t:"default",s=document.evaluate(l.MODEL_SELECTION_BUTTON_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(!s)return!1;s.click(),await new Promise(e=>setTimeout(e,500));const _=document.evaluate(i[c],document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(!_)return!1;_.click(),await new Promise(e=>setTimeout(e,500));const E=document.evaluate(l.ASPECT_RATIO_DROPDOWN_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(!E)return!1;E.click(),await new Promise(e=>setTimeout(e,500));const T="portrait"===n?l.PORTRAIT_ASPECT_RATIO_XPATH:l.LANDSCAPE_ASPECT_RATIO_XPATH,P=document.evaluate(T,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return!!P&&(P.click(),await new Promise(e=>setTimeout(e,500)),document.body.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape",keyCode:27,bubbles:!0,cancelable:!0,composed:!0})),await new Promise(e=>setTimeout(e,1e3)),!0)}catch(e){try{document.body.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape",keyCode:27,bubbles:!0,cancelable:!0,composed:!0}))}catch(e){}return!1}}export async function processImageAndPromptOnPage(e,t,n,l,o,u){try{let r=null,a=18e4;const i=500;for(;a>0;){try{r=document.evaluate(u.START_IMAGE_ADD_BUTTON_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(e){}if(r&&!r.disabled){r.click(),await new Promise(e=>setTimeout(e,2e3));break}await new Promise(e=>setTimeout(e,i)),a-=i}if(a<=0)return!1;let c=null,s=1e4;const _=250;for(;s>0;){let e=null;try{e=document.evaluate(u.HIDDEN_FILE_INPUT_XPATH,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null)}catch(e){}if(e&&e.snapshotLength>0){c=e.snapshotItem(e.snapshotLength-1);break}await new Promise(e=>setTimeout(e,_)),s-=_}if(!c)return!1;const E=await fetch(e),T=await E.blob(),P=new File([T],t,{type:n}),R=new DataTransfer;R.items.add(P),c.files=R.files,c.dispatchEvent(new Event("change",{bubbles:!0}));let d=document.evaluate(u.UPLOAD_SPINNER_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(d){let e=18e4;const t=500;for(;d&&e>0;)await new Promise(e=>setTimeout(e,t)),e-=t,d=document.evaluate(u.UPLOAD_SPINNER_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(e<=0)return!1}else await new Promise(e=>setTimeout(e,2e3));const m=document.evaluate(u.IMAGE_CROP_RATIO_DROPDOWN_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(m){m.click(),await new Promise(e=>setTimeout(e,500));const e="portrait"===o?u.IMAGE_CROP_RATIO_PORTRAIT_XPATH:u.IMAGE_CROP_RATIO_LANDSCAPE_XPATH,t=document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;t&&(t.click(),await new Promise(e=>setTimeout(e,500)))}const O=document.evaluate(u.CROP_AND_SAVE_BUTTON_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;O&&(O.click(),await new Promise(e=>setTimeout(e,1e3)));const D=document.getElementById(u.PROMPT_TEXTAREA_ID);if(!D)return!1;D.focus(),await new Promise(e=>setTimeout(e,50)),Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value").set.call(D,l),D.dispatchEvent(new Event("input",{bubbles:!0})),await new Promise(e=>setTimeout(e,50)),D.blur(),await new Promise(e=>setTimeout(e,50)),await new Promise(e=>setTimeout(e,4e3));let N=null,w=18e4;const A=1e3;let h=0;for(;h<w;){try{if(document.evaluate(u.IMAGE_POLICY_ERROR_POPUP_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue)return"POLICY_IMAGE"}catch(e){}try{N=document.evaluate(u.GENERATE_BUTTON_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(e){}if(N&&!N.disabled){N.click(),await new Promise(e=>setTimeout(e,1e3));for(let e=0;e<10;e++){if(document.evaluate(u.QUEUE_FULL_POPUP_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue)return"QUEUE_FULL";if(document.evaluate(u.PROMPT_POLICY_ERROR_POPUP_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue)return"POLICY_PROMPT";await new Promise(e=>setTimeout(e,1e3))}return!0}await new Promise(e=>setTimeout(e,A)),h+=A}return!1}catch(e){return!1}}export function findAndGroupNewVideos(e,t){const n=[],l=t.RESULT_CONTAINER_XPATH,o=t.PROMPT_IN_CONTAINER_XPATH,u=t.VIDEOS_IN_CONTAINER_XPATH;if(!l||!o||!u)return[];try{const t=document.evaluate(l,document,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);let r=t.iterateNext();for(;r;){try{const t=document.evaluate(o,r,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(t&&t.textContent){const l=t.textContent.trim(),o=[],a=document.evaluate(u,r,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);let i=a.iterateNext();for(;i;){const t=i.getAttribute("src");if(t&&t.startsWith("http")){const n=t.split("?")[0];e.includes(n)||o.push(t)}i=a.iterateNext()}o.length>0&&n.push({prompt:l,videos:o})}}catch(e){}r=t.iterateNext()}}catch(e){}return n}export function scanExistingVideos(){const e=new Set;try{document.querySelectorAll('video[src^="http"]').forEach(t=>{const n=t.getAttribute("src");n&&e.add(n.split("?")[0])})}catch(e){}return Array.from(e)}export function scanForPolicyError(e){return!!document.evaluate(e.PROMPT_POLICY_ERROR_POPUP_XPATH,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}