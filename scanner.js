import{dom as e}from"./dom.js";import{state as o}from"./state.js";import{logMessage as n,updateLiveStatus as t}from"./ui.js";import{i18n as r}from"./i18n.js";import{injectScript as d,findAndGroupNewVideos as s}from"./injector.js";import{interruptibleSleep as i}from"./utils.js";async function a(){if(!e.autoDownloadCheckbox.checked||!o.flowTabId)return;let t,a=null;if(o.isRunning&&o.masterQueue.length>0&&o.currentJobIndex<o.masterQueue.length&&(a=o.masterQueue[o.currentJobIndex]),0!==o.masterTaskList.filter(e=>"pending"===e.status).length||o.finalScanTimerId||o.isRunning){try{t=await d(s,[Array.from(o.downloadedVideoUrls)])}catch(e){return void(e.message.includes("No tab with id")||e.message.includes("Receiving end does not exist")?(o.stopRequested||n(r("error_tab_closed"),"error"),stopScanner()):o.stopRequested||n(r("log_scan_error",{error:e.message}),"error"))}if(Array.isArray(t)&&0!==t.length)for(const e of t){const t=o.masterTaskList.find(o=>o.prompt.trim()===e.prompt.trim()&&"pending"===o.status);if(!t)continue;const d=o.masterQueue.find(e=>e.id===t.jobId);if(!d)continue;const s=e.videos.filter(e=>!o.downloadedVideoUrls.has(e.split("?")[0]));if(0===s.length)continue;n(r("log_scan_found_videos",{count:s.length,prompt:t.prompt.substring(0,30)+"..."}),"info");const a="abcdefghijklmnopqrstuvwxyz";for(const e of s){if(t.foundVideos>=t.expectedVideos)break;const s=e.split("?")[0];if(o.downloadedVideoUrls.has(s))continue;o.downloadedVideoUrls.add(s),t.foundVideos++,o.newlyDownloadedCount++;const l=a[t.foundVideos-1]||t.foundVideos,u=new Date,c=`${u.getFullYear()}${(u.getMonth()+1).toString().padStart(2,"0")}${u.getDate().toString().padStart(2,"0")}_${u.getHours().toString().padStart(2,"0")}${u.getMinutes().toString().padStart(2,"0")}${u.getSeconds().toString().padStart(2,"0")}`,m=`${t.index}.${l}. ${c}.mp4`,f=`${d.downloadFolder||"Flow Downloads"}/${m}`;chrome.runtime.sendMessage({type:"downloadFile",url:e,filename:f},e=>{if(chrome.runtime.lastError){const e=chrome.runtime.lastError.message||r("log_download_runtime_error");o.stopRequested||e.includes(r("log_connection_error"))||e.includes(r("log_receiving_end_error"))||n(r("log_download_request_failed",{filename:f,error:e}),"error"),o.downloadedVideoUrls.delete(s),t.foundVideos--,o.newlyDownloadedCount--}else if(e?.success)n(r("log_download_video_named",{filename:f}),"success"),t.foundVideos>=t.expectedVideos&&(t.status="complete",n(r("log_task_complete",{index:t.index}),"success"));else{const d=e?.error||r("log_download_unknown_error");n(r("log_download_request_failed",{filename:f,error:d}),"error"),o.downloadedVideoUrls.delete(s),t.foundVideos--,o.newlyDownloadedCount--}}),await i(300)}}}}export function startScanner(e){stopScanner(),o.downloadInterval=setInterval(a,o.scanIntervalMs)}export function stopScanner(){o.downloadInterval&&(clearInterval(o.downloadInterval),o.downloadInterval=null)}