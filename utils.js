import{state as e}from"./state.js";import{logMessage as t}from"./ui.js";import{i18n as o}from"./i18n.js";import{scanForPolicyError as r,injectScript as a}from"./injector.js";export const naturalSortCollator=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});export function getProjectIdFromUrl(e){if(!e)return null;const t=e.match(/project\/([a-zA-Z0-9_-]+)/);return t?t[1]:null}export function readFileAsDataURL(e){return new Promise(r=>{const a=new FileReader;a.onload=()=>r(a.result),a.onerror=()=>{t(o("log_file_read_error",{filename:e.name}),"error"),r(null)},a.readAsDataURL(e)})}export function sortImageFiles(t){if(e.imageFileList&&0!==e.imageFileList.length)switch(t){case"az":e.imageFileList.sort((e,t)=>naturalSortCollator.compare(e.name,t.name));break;case"za":e.imageFileList.sort((e,t)=>naturalSortCollator.compare(t.name,e.name));break;case"newest":e.imageFileList.sort((e,t)=>t.lastModified-e.lastModified);break;case"oldest":e.imageFileList.sort((e,t)=>e.lastModified-t.lastModified)}}export function getRandomWait(e,t){const o=parseInt(e||"90",10)||90,r=parseInt(t||"120",10)||120,a=Math.min(o,r),n=Math.max(o,r);return Math.max(1e3,1e3*(Math.floor(Math.random()*(n-a+1))+a))}export async function pauseIfNeeded(){for(;e.isPaused&&!e.stopRequested;)await new Promise(e=>setTimeout(e,500))}export async function interruptibleSleep(t){const o=Date.now()+t;for(;Date.now()<o;){if(await pauseIfNeeded(),e.stopRequested)return!0;const t=o-Date.now();await new Promise(e=>setTimeout(e,Math.min(250,t>0?t:0)))}return!1}export async function interruptibleSleepAndScan(t){const o=Date.now()+t;let n=Date.now()+4e3;for(;Date.now()<o;){if(await pauseIfNeeded(),e.stopRequested)return"STOPPED";const t=Date.now();if(t>=n){try{if(await a(r))return"POLICY_ERROR"}catch(e){}n=t+1e3}const i=o-t,s=Math.min(250,i>0?i:0,n-t);await new Promise(e=>setTimeout(e,s>0?s:0))}return"COMPLETED"}export async function waitForTabLoad(e){return new Promise((t,r)=>{const a=(o,r,n)=>{o===e&&"complete"===n.status&&n.url.includes("/project/")&&(chrome.tabs.onUpdated.removeListener(a),t())};chrome.tabs.onUpdated.addListener(a),setTimeout(()=>{chrome.tabs.onUpdated.removeListener(a),r(new Error(o("log_page_reload_fail")))},6e4)})}